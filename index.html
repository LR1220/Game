<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üïµÔ∏è‚Äç‚ôÇÔ∏èEl Misterio de los Sentidos ‚Äî Juego Completo</title>
<link rel="preload" as="audio" href="lavadora.mp3">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Special+Elite&display=swap" rel="stylesheet">
<style>
:root{--accent:#b80000;--accent-dark:#9e0000;--bg:#1c1c1c;--panel:rgba(28,28,28,0.95);--success:#2ecc71}
*{box-sizing:border-box}
body{margin:0;font-family:'Nunito',sans-serif;background:var(--bg);color:#eef2f3;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{width:100%;max-width:900px;background:var(--panel);border:2px solid var(--accent);border-radius:12px;padding:26px;box-shadow:0 12px 40px rgba(0,0,0,0.6);text-align:center}
h1,h2{font-family:'Special Elite',cursive;color:var(--accent);margin:0 0 8px;text-align:center}
.subtitle{font-size:0.98rem;color:#c7d0d4;margin-bottom:14px;text-align:center}
.progress-wrap{width:100%;background:#6f7b80;border-radius:8px;height:14px;overflow:hidden;margin:10px 0}
.progress-bar{height:100%;width:0%;background:var(--success);transition:width .5s ease}
#riddle-text{font-size:1.05rem;margin:8px 0;text-align:center}
.row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
input[type=text]{background:rgba(255,255,255,0.06);border:1px solid var(--accent);color:#fff;padding:8px 10px;border-radius:6px}
button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
button:hover{background:var(--accent-dark)}
#next-riddle-button{background:#ff8c00 !important;color:#fff !important;padding:12px 18px;border-radius:10px;box-shadow:0 8px 18px rgba(255,140,0,0.28);font-weight:800;border:none}
#next-riddle-button:hover{transform:translateY(-2px)}
body::before{content:"";position:fixed;inset:0;background-image:url('https://img.freepik.com/free-photo/truth-concept-composition-detective-desk_23-2149051319.jpg?semt=ais_hybrid&w=740&q=80');background-size:cover;background-position:center;opacity:0.75;z-index:-1}
#floor-plan-container{position:relative;max-width:520px;margin:12px auto 0;display:none}
#floor-plan{width:100%;border-radius:8px;display:block}
.hotspot{position:absolute;border:2px solid yellow;background:rgba(255,255,0,0.18);opacity:0;border-radius:6px;transition:opacity .25s, transform .18s;z-index:999;pointer-events:auto}
.hotspot.active{opacity:1;transform:scale(1.03);box-shadow:0 8px 30px rgba(255,230,0,0.12)}
#bed-hotspot{top:14%;right:6%;width:26%;height:26%}
#riddle-3-interaction{display:none;text-align:center;margin-top:12px}
#secret-slider{width:90%;max-width:420px}
#hidden-word{font-weight:800}
#memory-board{display:grid;grid-template-columns:repeat(4,80px);gap:10px;justify-content:center;margin-top:12px}
.memory-card{width:80px;height:100px;background:#7b4f2c;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;user-select:none;color:#fff}
.memory-card.revealed{background:#fff;color:#000}
.memory-card.matched{background:var(--success);color:#012}
#puzzle-board{width:300px;height:300px;margin:12px auto;display:grid;grid-template-columns:repeat(3,1fr);gap:0;border:3px solid var(--accent);border-radius:6px;overflow:hidden}
.puzzle-slot{width:100px;height:100px;border:1px dashed rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center}
.puzzle-piece{width:100px;height:100px;cursor:grab;background-image:url('https://content.elmueble.com/medio/2023/10/26/sigue-estos-trucos-para-alargar-la-vida-de-tus-plantas-en-macetas_b6d2aa07_231026103457_900x900.jpg');background-size:300px 300px}
#piece-1 {background-position:   0   0;}
#piece-2 {background-position: -100px   0;}
#piece-3 {background-position: -200px   0;}
#piece-4 {background-position:   0  -100px;}
#piece-5 {background-position: -100px -100px;}
#piece-6 {background-position: -200px -100px;}
#piece-7 {background-position:   0  -200px;}
#piece-8 {background-position: -100px -200px;}
#piece-9 {background-position: -200px -200px;}
#puzzle-pieces-container{display:grid;grid-template-columns:repeat(3,auto);gap:5px;justify-content:center;margin-top:10px}
#final-overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:9999}
#final-box{background:linear-gradient(135deg,#111,#222);padding:26px;border-radius:12px;border:2px solid var(--accent);color:#fff;text-align:center}
.feedback{margin-top:12px;font-weight:700;text-align:center}
.small-muted{color:#bfc7c9;text-align:center}
</style>
</head>
<body>
<div class="container" id="start-overlay">
  <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è El Misterio de los Sentidos</h1>
  <div style="display:flex;justify-content:center;margin-top:12px"><button id="start-button">¬°Comenzar misi√≥n!</button></div>
</div>

<div class="container" id="verification-container" style="display:none;">
  <h2>Verificaci√≥n</h2>
  <p id="verification-message" class="small-muted">Muestra tu carnet  ante la c√°mara para continuar</p>
  
  <div style="position: relative; display:inline-block; width:100%; max-width:420px;">
    <video id="verification-feed" autoplay playsinline style="width:100%; border-radius:8px; display:none"></video>
    <!-- Marco tem√°tico -->
    <img src="https://cdn-icons-png.flaticon.com/512/1320/1320519.png" 
         alt="Marco detective" 
         style="position:absolute; top:0; left:0; width:25; height:25%; pointer-events:none; border-radius:8px;">
  </div>

  <!-- üîπ Aqu√≠ agregamos el bot√≥n que faltaba -->
  <div style="margin-top:14px; text-align:center;">
    <button id="verify-button">Verificar carnet</button>
  </div>

  <!-- Si quieres mostrar mensajes adicionales -->
  <p id="verification-feedback" class="feedback"></p>
</div>



<div class="container" id="game-container" style="display:none;">
  <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è El Misterio de los Sentidos</h1>
  <p class="subtitle">Recupera los regalos antes de que sea demasiado tarde</p>
  <div class="progress-wrap"><div class="progress-bar" id="progress-bar"></div></div>
  <p id="riddle-text"></p>

  <div id="game-controls" class="row" style="display:none;margin-top:8px">
    <input type="text" id="answer-input" placeholder="Escribe el nombre del objeto" />
    <button id="answer-button">Resolver Acertijo</button>
  </div>

  <div id="floor-plan-container">
    <img id="floor-plan" src="https://static.planner5d.com/assets/images/recognition/recognition-how-work-1-1.webp?ux=6.307.5" alt="Plano" />
    <div class="hotspot" id="bed-hotspot" aria-hidden="true"></div>
  </div>

  <div id="riddle-2-interaction" style="display:none;margin-top:12px">
    <p>Usa tu o√≠do: escucha y descubre d√≥nde est√° el regalo</p>
    <div class="row" style="margin-top:8px">
      <button id="play-sound">Escuchar sonido</button>
      <button id="stop-sound" style="background:#444;">Detener sonido</button>
      <input type="text" id="answer-input-riddle2" placeholder="Nombre del objeto..." />
      <button id="answer-sound-button">Resolver</button>
    </div>
  </div>

  <div id="riddle-3-interaction" style="display:none">
    <p>Mueve el deslizador a la posici√≥n exacta para revelar la palabra oculta</p>
    <input id="secret-slider" type="range" min="0" max="100" value="0" />
    <p>Posici√≥n: <span id="slider-value">0</span>% ‚Äî Palabra: <span id="hidden-word">[___]</span></p>
    <div class="row" style="margin-top:8px">
      <input type="text" id="answer-input-slider" placeholder="Escribe el nombre del objeto" />
      <button id="answer-button-slider">Resolver</button>
    </div>
  </div>

  <div id="riddle-bookshelf-memory" style="display:none; margin-top:12px;">
    <p class="subtitle">Encuentra los pares de libros iguales</p>
    <div id="memory-board"></div>
    <p id="memory-feedback" class="feedback"></p>
  </div>

  <div id="puzzle-container" style="display:none; margin-top:12px">
    <div id="puzzle-board"></div>
    <div id="puzzle-pieces-container"></div>
    <p id="puzzle-feedback" class="feedback"></p>
    <div style="display:flex;justify-content:center;margin-top:8px;gap:12px" aria-label="Controles del rompecabezas">
  <button id="check-puzzle-button" style="display:none">Verificar Rompecabezas</button>
  <button id="reset-puzzle-button">Reiniciar Rompecabezas</button>
</div>
  </div>

  <div style="display:flex;justify-content:center;margin-top:14px">
    <button id="next-riddle-button" style="display:none;">Siguiente reto</button>
  </div>

  <p id="feedback" class="feedback"></p>
</div>

<audio id="washing-audio" src="lavadora.mp3" preload="auto"></audio>

<div id="final-overlay"><div id="final-box"><h2 id="final-title">¬°FELICIDADES!</h2><p id="final-message">Has encontrado todos los regalos.</p><div style="margin-top:12px"><button id="close-final">Cerrar</button></div></div></div>

<script>
// ----- Configuraci√≥n de acertijos -----
const riddles = [
  { id:'bed', interaction:'hotspot', riddle: "El primer regalo est√° escondido en el lugar que te recibe cada noche. Pasa el dedo o el cursor por el sitio correcto.", solved:false },
  { id:'washing', interaction:'sound', riddle: "En mi interior, la ropa sucia se vuelve limpia. Escucha y adivina.", answer:'lavadora', solved:false },
  { id:'closet', interaction:'slider', riddle: "Guardo tu [    ] limpia y doblada, puedes abrirme cada ma√±ana. ¬øQu√© soy?", targetValue:73, hiddenWord:'ROPA', answer:'closet', solved:false },
  { id:'bookshelf', interaction:'memory', riddle: "", solved:false },
  { id:'plant', interaction:'puzzle', riddle: "Arma el rompecabezas para encontrar el lugar donde esta oculto t√∫ √∫ltimo regalo.", answer:'planta', solved:false }
];

let currentIndex = 0;
let currentStream = null;
let hotspotHandled = false;

// ----- DOM refs -----
const startOverlay = document.getElementById('start-overlay');
const startButton = document.getElementById('start-button');
const verificationContainer = document.getElementById('verification-container');
const verificationFeed = document.getElementById('verification-feed');
const verifyButton = document.getElementById('verify-button');
const verificationFeedback = document.getElementById('verification-feedback');
const verificationMessage = document.getElementById('verification-message');
const gameContainer = document.getElementById('game-container');
const progressBar = document.getElementById('progress-bar');
const riddleText = document.getElementById('riddle-text');
const gameControls = document.getElementById('game-controls');
const answerInput = document.getElementById('answer-input');
const answerButton = document.getElementById('answer-button');
const floorPlanContainer = document.getElementById('floor-plan-container');
const bedHotspot = document.getElementById('bed-hotspot');
const riddle2Interaction = document.getElementById('riddle-2-interaction');
const playSoundBtn = document.getElementById('play-sound');
const stopSoundBtn = document.getElementById('stop-sound');
const answerSoundInput = document.getElementById('answer-input-riddle2');
const answerSoundBtn = document.getElementById('answer-sound-button');
const riddle3Interaction = document.getElementById('riddle-3-interaction');
const secretSlider = document.getElementById('secret-slider');
const sliderValueEl = document.getElementById('slider-value');
const hiddenWordEl = document.getElementById('hidden-word');
const answerInputSlider = document.getElementById('answer-input-slider');
const answerButtonSlider = document.getElementById('answer-button-slider');
const memoryBoard = document.getElementById('memory-board');
const memoryFeedback = document.getElementById('memory-feedback');
const puzzleContainer = document.getElementById('puzzle-container');
const puzzleBoard = document.getElementById('puzzle-board');
const puzzlePiecesContainer = document.getElementById('puzzle-pieces-container');
const puzzleFeedback = document.getElementById('puzzle-feedback');
const checkPuzzleBtn = document.getElementById('check-puzzle-button');
const resetPuzzleBtn = document.getElementById('reset-puzzle-button');
const washingAudio = document.getElementById('washing-audio');
const feedback = document.getElementById('feedback');
const finalOverlay = document.getElementById('final-overlay');
const closeFinal = document.getElementById('close-final');
const nextRiddleBtn = document.getElementById('next-riddle-button');

// ----- Audio helpers -----
let audioCtx = null;
function ensureAudioCtx(){ if(!audioCtx){ try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioCtx = null; } } }
function beep(freq, dur=0.12){ ensureAudioCtx(); if(!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sine'; o.frequency.value = freq; g.gain.value = 0.0001; o.connect(g); g.connect(audioCtx.destination); const now = audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(0.2, now+0.01); o.start(now); g.gain.exponentialRampToValueAtTime(0.0001, now+dur); o.stop(now+dur+0.02); }
function playCorrect(){ 
  beep(880,0.12); 
  if (navigator.vibrate) navigator.vibrate(120); // vibraci√≥n corta
}

function playIncorrect(){ 
  beep(220,0.12); 
  if (navigator.vibrate) navigator.vibrate([120, 80, 120]); // vibraci√≥n doble
}

function playFinal(){ beep(880,0.08); setTimeout(()=>beep(1046,0.08),120); setTimeout(()=>beep(1318,0.12),260); }

// ----- Next button control -----
function enableNextButton(){ nextRiddleBtn.style.display = 'inline-block'; }
nextRiddleBtn.addEventListener('click', ()=>{ nextRiddleBtn.style.display = 'none'; currentIndex++; loadRiddle(currentIndex); });

// ----- Start/verification -----
startButton.addEventListener('click', ()=>{ startOverlay.style.display='none'; verificationContainer.style.display='block'; startCamera(); });
verifyButton.addEventListener('click', ()=>{
  stopCamera();
verifyButton.style.display = 'none';
  // show welcome message before proceeding to first riddle
  verificationMessage.textContent = "Bienvenido a tu misi√≥n detective Carlos alias Pollito üê•";
  verificationMessage.style.color = 'var(--success)';
  verificationFeedback.textContent = '';
  // wait 4 seconds to let the player read
  setTimeout(()=>{
    verificationContainer.style.display='none';
    gameContainer.style.display='block';
    loadRiddle(currentIndex);
  }, 2000);
});

async function startCamera(){
  if(currentStream){ stopCamera(); }

  // Primero intentamos solicitar espec√≠ficamente la c√°mara trasera (ideal)
  const envConstraints = { video: { facingMode: { ideal: "environment" } }, audio: false };

  try{
    try {
      // intentamos con facingMode ideal -> en la mayor√≠a de m√≥viles abrir√° la trasera
      currentStream = await navigator.mediaDevices.getUserMedia(envConstraints);
    } catch (errEnv) {
      // fallback si facingMode no est√° soportado o falla: pedimos cualquier c√°mara
      console.warn('No se pudo abrir la c√°mara trasera por facingMode, intentando cualquier c√°mara...', errEnv);
      currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    }

    verificationFeed.srcObject = currentStream;
    verificationFeed.style.display = 'block';
    verificationMessage.textContent = 'C√°mara activada';
    verificationMessage.style.color = 'var(--accent)';
    verificationFeedback.textContent = '';
  }catch(err){
    verificationMessage.textContent = 'No se pudo acceder a la c√°mara. Puedes continuar sin verificar.';
    verificationMessage.style.color='orange';
    verificationFeedback.textContent = '';
    console.warn(err);
  }
}

function stopCamera(){ if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; verificationFeed.srcObject=null; verificationFeed.style.display='none'; } }

// ----- Progress -----
function updateProgress(forceFull=false){ const solved = riddles.filter(r=>r.solved).length; const pct = forceFull?100: Math.round((solved / riddles.length)*100); progressBar.style.width = pct+'%'; }

// ----- Load riddle -----
function loadRiddle(idx){
  // stop any audio and hide next button when loading a new riddle
  washingAudio.pause(); washingAudio.currentTime = 0;
  nextRiddleBtn.style.display = 'none';

  if(idx>=riddles.length){ updateProgress(true); playFinal(); setTimeout(()=>showFinal(),700); return; }
  const r = riddles[idx];
  riddleText.textContent = r.riddle;
  feedback.textContent = '';

  // hide all interactions by default
  gameControls.style.display='none';
  floorPlanContainer.style.display='none';
  riddle2Interaction.style.display='none';
  riddle3Interaction.style.display='none';
  document.getElementById('riddle-bookshelf-memory').style.display='none';
  puzzleContainer.style.display='none';

  if(r.interaction==='hotspot'){ floorPlanContainer.style.display='block'; hotspotHandled=false; bedHotspot.classList.remove('active'); }
  if(r.interaction==='sound'){ riddle2Interaction.style.display='block'; }
  if(r.interaction==='slider'){
    riddle3Interaction.style.display='block';
    gameControls.style.display='none';
    hiddenWordEl.textContent = '[___]';
    secretSlider.value = 0;
    sliderValueEl.textContent = '0';
    feedback.textContent = 'Ajusta el deslizador hasta encontrar la combinaci√≥n.';
  }
  if(r.interaction==='memory'){ document.getElementById('riddle-bookshelf-memory').style.display='block'; initializeMemoryGame(); }
  if(r.interaction==='puzzle'){ puzzleContainer.style.display='block'; initializePuzzleBoard(); }
  updateProgress();
}

// ----- Hotspot (bed) -----
function handleHotspot(isOver){ const r = riddles[currentIndex]; if(r.interaction!=='hotspot' || r.solved || hotspotHandled) return; if(isOver){ hotspotHandled=true; bedHotspot.classList.add('active'); playCorrect(); r.solved=true; updateProgress(); riddleText.textContent = '¬°Has resuelto el acertijo! El regalo est√° oculto bajo la cama.'; enableNextButton(); } }
// use pointer events for reliable hover detection (mouse & touch pointers)
bedHotspot.addEventListener('pointerenter', ()=>handleHotspot(true));
bedHotspot.addEventListener('click', ()=>handleHotspot(true));
bedHotspot.addEventListener('touchstart', ()=>handleHotspot(true));
// keep touchstart detection on container but DO NOT require click; the pointer events above will fire on touch-capable browsers that support pointer events
floorPlanContainer.addEventListener('touchstart', function(e){ if(riddles[currentIndex] && riddles[currentIndex].interaction==='hotspot'){ const t = e.touches[0]; const rect = bedHotspot.getBoundingClientRect(); const isOver = (t.clientX>=rect.left && t.clientX<=rect.right && t.clientY>=rect.top && t.clientY<=rect.bottom); if(isOver) handleHotspot(true); } }, {passive:false});

// ----- Sound riddle -----
playSoundBtn.addEventListener('click', ()=>{ washingAudio.currentTime = 0; const p = washingAudio.play(); if(p && typeof p.catch==='function') p.catch(()=>{}); });
stopSoundBtn.addEventListener('click', ()=>{ washingAudio.pause(); washingAudio.currentTime = 0; feedback.textContent = 'Audio detenido.'; });
answerSoundBtn.addEventListener('click', ()=>{ const guess = (answerSoundInput.value||'').toLowerCase().trim(); const r = riddles[currentIndex]; if(guess === (r.answer||'').toLowerCase()){ playCorrect(); r.solved=true; updateProgress(); feedback.textContent='¬°Correcto! El regalo est√° en la lavadora.'; washingAudio.pause(); washingAudio.currentTime = 0; enableNextButton(); } else { playIncorrect(); feedback.textContent='Respuesta incorrecta'; } });

// ----- Slider riddle (closet) -----
let sliderInZone = false;
const SLIDER_TOLERANCE = 1; // +/- value
secretSlider.addEventListener('input', (e)=>{
  const v = parseInt(e.target.value,10);
  sliderValueEl.textContent = v;
  const r = riddles[currentIndex];
  if(r && r.interaction==='slider'){
    const inZone = Math.abs(v - r.targetValue) <= SLIDER_TOLERANCE;
    if(inZone && !sliderInZone){
      sliderInZone = true;
      hiddenWordEl.textContent = r.hiddenWord;
      hiddenWordEl.style.color = 'var(--success)';
      feedback.textContent = `¬°Combinaci√≥n encontrada! Con la palabra ${r.hiddenWord} revelada, ahora escribe el objeto del acertijo.`;
      playCorrect();
    } else if(!inZone && sliderInZone){
      sliderInZone = false;
      hiddenWordEl.textContent = '[___]';
      hiddenWordEl.style.color = '';
      feedback.textContent = 'Sigue buscando, est√°s cerca.';
    } else {
      if(!inZone){ hiddenWordEl.textContent = '[___]'; hiddenWordEl.style.color = ''; feedback.textContent = 'Sigue buscando, est√°s cerca.'; }
    }
  }
});

// Respuesta √∫nica para el closet (usa la caja #answer-input-slider)
answerButtonSlider.addEventListener('click', ()=>{
  const r = riddles[currentIndex];
  const guess = (answerInputSlider.value||'').toLowerCase().trim();
  if(r.interaction !== 'slider'){ playIncorrect(); feedback.textContent='Este control no aplica aqu√≠'; return; }
  if(!hiddenWordEl.textContent || hiddenWordEl.textContent==='[________]'){ playIncorrect(); feedback.textContent='Primero revela la palabra oculta con el deslizador.'; return; }
  if(guess === (r.answer||'').toLowerCase()){
    playCorrect(); r.solved=true; updateProgress(); feedback.textContent='¬°Correcto! El regalo est√° en el cl√≥set.'; enableNextButton();
  } else { playIncorrect(); feedback.textContent='Respuesta incorrecta'; }
});

// ----- Memory game -----
const bookEmojis = ['üìò','üìï','üìó','üìô'];
let cardSymbols = [];
let flipped = [];
let matches = 0;
function initializeMemoryGame(){ memoryBoard.innerHTML=''; memoryFeedback.textContent=''; flipped = []; matches = 0; cardSymbols = shuffle(bookEmojis.concat(bookEmojis)); cardSymbols.forEach((sym,i)=>{ const card = document.createElement('div'); card.className = 'memory-card'; card.dataset.symbol = sym; card.dataset.index = i; card.textContent = 'üìö'; card.addEventListener('click', ()=>flipCard(card)); memoryBoard.appendChild(card); }); }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]] = [arr[j],arr[i]]; } return arr; }
function flipCard(card){ if(card.classList.contains('matched') || flipped.length === 2) return; card.textContent = card.dataset.symbol; card.classList.add('revealed'); flipped.push(card); if(flipped.length === 2){ setTimeout(checkMemoryMatch, 600); } }
function checkMemoryMatch(){ const [a,b] = flipped; if(!a || !b){ flipped = []; return; } if(a.dataset.symbol === b.dataset.symbol){ a.classList.add('matched'); b.classList.add('matched'); a.dataset.revealed = 'true'; b.dataset.revealed = 'true'; matches++; playCorrect(); if(matches === bookEmojis.length){ memoryFeedback.textContent = '¬°Has encontrado todos los pares! El regalo est√° en la estanter√≠a de libros.'; riddles[currentIndex].solved = true; updateProgress(); enableNextButton(); } } else { a.dataset.revealed = 'false'; b.dataset.revealed = 'false'; a.classList.remove('revealed'); b.classList.remove('revealed'); a.textContent = 'üìö'; b.textContent = 'üìö'; playIncorrect(); memoryFeedback.textContent = 'No coinciden, intenta de nuevo.'; } flipped = []; }

// ----- Puzzle -----
function initializePuzzleBoard(){
  puzzleBoard.innerHTML = '';
  puzzlePiecesContainer.innerHTML = '';
  for(let i=1;i<=9;i++){
    const slot = document.createElement('div');
    slot.className = 'puzzle-slot';
    slot.dataset.slot = i;
    slot.addEventListener('dragover', e=>e.preventDefault());
    slot.addEventListener('drop', dropPuzzle);
    puzzleBoard.appendChild(slot);
  }

  const pieces = [];
  for(let i=1;i<=9;i++){
    const p = document.createElement('div');
    p.className = 'puzzle-piece';
    p.id = 'piece-'+i;
    p.draggable = true;
    p.addEventListener('dragstart', e=>e.dataTransfer.setData('text/plain', e.target.id));
    pieces.push(p);
// soporte t√°ctil
p.addEventListener('touchstart', onTouchStart, {passive:false});
  }

  while(pieces.length){ const j = Math.floor(Math.random()*pieces.length); puzzlePiecesContainer.appendChild(pieces.splice(j,1)[0]); }
  checkPuzzleBtn.style.display = 'none';
}
function dropPuzzle(e){ 
  e.preventDefault(); 
  const id = e.dataTransfer.getData('text/plain'); 
  const piece = document.getElementById(id); 
  let target = e.target; 
  if(!target.classList.contains('puzzle-slot')) target = target.closest('.puzzle-slot'); 
  if(target && target.children.length === 0){ 
    target.appendChild(piece); 
    const filled = Array.from(puzzleBoard.children).filter(s=>s.children.length>0).length; 
    if(filled > 0) checkPuzzleBtn.style.display = 'inline-block'; 
    else checkPuzzleBtn.style.display = 'none'; 
  } 
}

checkPuzzleBtn.addEventListener('click', ()=>{
  const slots = puzzleBoard.querySelectorAll('.puzzle-slot');
  let ok = true;
  for(let i=0;i<9;i++){
    const s = slots[i];
    const expected = 'piece-'+(i+1);
    if(!s.children[0] || s.children[0].id !== expected){
      ok = false;
      break;
    }
  }

  if(ok){
    // Mensaje especial que pediste
    puzzleFeedback.textContent = '¬°Rompecabezas resuelto! El regalo est√° oculto en una de las macetas de la casa.';
    playCorrect();
    riddles[currentIndex].solved = true;
    updateProgress();

    // Deshabilitar controles para evitar que muevan piezas durante la espera
    checkPuzzleBtn.disabled = true;
    resetPuzzleBtn.disabled = true;
    puzzlePiecesContainer.style.pointerEvents = 'none';

    // Mantener la pantalla 3 segundos y luego pasar a la pantalla final
    setTimeout(()=>{
      // Marcar progreso completo y reproducir tono final
      updateProgress(true);
      playFinal();
      showFinal(); // muestra el overlay final "¬°FELICIDADES!"
    }, 3000);

  } else {
    puzzleFeedback.textContent = 'El orden no es correcto. ¬°Intenta de nuevo!';
    playIncorrect();
  }
});

resetPuzzleBtn.addEventListener('click', ()=>{ initializePuzzleBoard(); puzzleFeedback.textContent = ''; });

// ----- Soporte t√°ctil para el rompecabezas -----
// ----- Soporte t√°ctil optimizado -----
let draggingPiece = null;
let startX = 0, startY = 0;
let currentX = 0, currentY = 0;

function onTouchStart(e) {
  e.preventDefault();
  draggingPiece = e.target;

  const touch = e.touches[0];
  startX = touch.clientX;
  startY = touch.clientY;

  // reset transform al iniciar
  draggingPiece.style.transition = "none";
  draggingPiece.style.zIndex = "1000";

  document.addEventListener('touchmove', onTouchMove, {passive:false});
  document.addEventListener('touchend', onTouchEnd, {passive:false});
}

function onTouchMove(e) {
  if (!draggingPiece) return;
  const touch = e.touches[0];
  currentX = touch.clientX - startX;
  currentY = touch.clientY - startY;

  // mover con transform para que siga el dedo exactamente
  draggingPiece.style.transform = `translate(${currentX}px, ${currentY}px)`;
}

function onTouchEnd(e) {
  if (!draggingPiece) return;

  const touch = e.changedTouches[0];
  const x = touch.clientX;
  const y = touch.clientY;

  const slots = document.querySelectorAll('.puzzle-slot');
  let dropped = false;

  slots.forEach(slot => {
    const rect = slot.getBoundingClientRect();
    if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
      if (slot.children.length === 0) {
        slot.appendChild(draggingPiece);
        draggingPiece.style.transform = "none";  // quitar movimiento
        draggingPiece.style.transition = "transform 0.2s ease";
        draggingPiece.style.zIndex = "auto";
        dropped = true;
      }
    }
  });

  if (!dropped) {
    // regresar al contenedor original
    document.getElementById('puzzle-pieces-container').appendChild(draggingPiece);
    draggingPiece.style.transform = "none";
    draggingPiece.style.transition = "transform 0.2s ease";
    draggingPiece.style.zIndex = "auto";
  }

  draggingPiece = null;
  document.removeEventListener('touchmove', onTouchMove);
  document.removeEventListener('touchend', onTouchEnd);
}


// ----- Final overlay -----
function showFinal(){
  finalOverlay.style.display = 'flex';

  // Agregar canvas de confeti
  const canvas = document.createElement('canvas');
  canvas.id = "confetti-canvas";
  canvas.style.position = "fixed";
  canvas.style.top = "0";
  canvas.style.left = "0";
  canvas.style.width = "100%";
  canvas.style.height = "100%";
  canvas.style.pointerEvents = "none";
  canvas.style.zIndex = "10000";
  document.body.appendChild(canvas);

  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const pieces = new Array(120).fill().map(()=>({
    x: Math.random()*canvas.width,
    y: Math.random()*canvas.height,
    w: 5+Math.random()*5,
    h: 10+Math.random()*10,
    color: `hsl(${Math.random()*360}, 100%, 50%)`,
    vy: 2+Math.random()*3,
    vx: -2+Math.random()*4,
    angle: Math.random()*2*Math.PI
  }));

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let p of pieces){
      ctx.fillStyle = p.color;
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.angle);
      ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      ctx.restore();
      p.x += p.vx;
      p.y += p.vy;
      p.angle += 0.05;
      if(p.y > canvas.height) p.y = -10;
      if(p.x > canvas.width) p.x = 0;
      if(p.x < 0) p.x = canvas.width;
    }
    requestAnimationFrame(draw);
  }
  draw();
}

closeFinal.addEventListener('click', ()=>{ finalOverlay.style.display = 'none'; location.reload(); });

// ----- Init -----
document.addEventListener('DOMContentLoaded', ()=>{ updateProgress(); });
</script>
</body>
</html>

